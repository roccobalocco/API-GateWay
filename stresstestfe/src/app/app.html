<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>Kubernetes Dashboard & Load Tester</h1>
    @if (isAuthenticated) {
      <div class="auth-status">
        <span class="status-badge success">üü¢ Autenticato</span>
      </div>
    } @else {
      <div class="auth-status">
        <span class="status-badge error">üü¢ Autenticato</span>
      </div>
    }
  </header>
  <app-rate-limiting-info>
  </app-rate-limiting-info>
  <!-- Login Section -->
  @if (!isAuthenticated) {
    <div class="login-section">
      <div class="card">
        <h2>üîê Login</h2>
        <form (ngSubmit)="login()" class="login-form">
          <div class="form-group">
            <label for="username">Username:</label>
            <input
              id="username"
              type="text"
              [(ngModel)]="credentials.username"
              name="username"
              required
              class="form-control"
            >
          </div>
          <div class="form-group">
            <label for="password">Password:</label>
            <input
              id="password"
              type="password"
              [(ngModel)]="credentials.password"
              name="password"
              required
              class="form-control"
            >
          </div>
          <button type="submit" class="btn btn-primary" [disabled]="isLoading">
            {{ isLoading ? 'Accesso...' : 'Login' }}
          </button>
        </form>
      </div>
    </div>
  } @else {
    <!-- Main Dashboard -->
    <div class="main-dashboard">
      <!-- Health Status Section -->
      <div class="health-section">
        <div class="card">
          <h2>üìä Stato di Salute del Sistema</h2>

          <div class="health-controls">
            <button (click)="refreshHealth()" class="btn btn-secondary" [disabled]="isLoading">
              üîÑ Aggiorna
            </button>
            <label class="auto-refresh">
              <input
                type="checkbox"
                [(ngModel)]="autoRefresh"
                (change)="toggleAutoRefresh()"
              >
              Auto-refresh (30s)
            </label>
          </div>

          <div class="health-grid">

            <!-- Summary status per service (boolean values) -->
            <div class="health-card" *ngIf="summaryStatus">
              <h3>Health Summary</h3>
              <div class="health-info" *ngFor="let service of objectKeys(summaryStatus)">
                <div class="status-indicator" [class]="getServiceHealthClass(service)">
                  {{ service }}: {{ summaryStatus[service] ? 'Healthy' : 'Unhealthy' }}
                </div>
              </div>
            </div>

            <!-- Per-service detailed stats -->
            <div class="health-card" *ngIf="servicesStats?.length">
              <h3>Statistiche Servizi</h3>
              <div *ngFor="let svc of servicesStats" class="service-stat">
                <h4>{{ svc.serviceName }}</h4>
                <p><strong>Totale richieste:</strong> {{ svc.totalRequests }}</p>
                <p><strong>Tempo medio risposta:</strong> {{ formatAvgResponseTime(svc.avgResponseTime) }}</p>
                <p><strong>Ultima chiamata:</strong> {{ svc.lastCalled | date:'short' }}</p>

                <p><strong>Metodi:</strong>
                  <span *ngFor="let method of objectKeys(svc.methodCounts); let last = last">
              {{ method }} ({{ svc.methodCounts[method] }})<span *ngIf="!last">, </span>
            </span>
                </p>

                <p><strong>Utenti:</strong>
                  <span *ngFor="let user of objectKeys(svc.users); let last = last">
              {{ user }} ({{ svc.users[user] }})<span *ngIf="!last">, </span>
            </span>
                </p>

                <p><strong>Endpoint:</strong>
                  <span *ngFor="let path of objectKeys(svc.paths); let last = last">
              {{ path }} ({{ svc.paths[path] }})<span *ngIf="!last">, </span>
            </span>
                </p>

                <hr>
              </div>
            </div>

            <!-- Loading or no-data state -->
            <div class="health-card" *ngIf="!servicesStats?.length && !isLoading">
              <div class="no-data">Nessun dato disponibile</div>
            </div>

          </div>
        </div>
      </div>
      <!-- Load Testing Section -->
      <div class="load-test-section">
        <div class="card">
          <h2>üöÄ Test di Resistenza Kubernetes</h2>
          <div class="test-config">
            <h3>Configurazione Test</h3>
            <div class="config-grid">
              <div class="form-group">
                <label for="endpoint">Endpoint:</label>
                <select
                  id="endpoint"
                  [(ngModel)]="loadTestConfig.endpoint"
                  class="form-control"
                >
                  <option value="Book">Book Service</option>
                  <option value="User">User Service</option>
                  <option value="Room">Room Service</option>
                  <option value="Loan">Loan Service</option>
                </select>
              </div>

              <div class="form-group">
                <label for="method">Metodo:</label>
                <select
                  id="method"
                  [(ngModel)]="loadTestConfig.method"
                  class="form-control"
                >
                  <option value="GET">GET</option>
                  <option value="POST">POST</option>
                  <option value="PUT">PUT</option>
                  <option value="DELETE">DELETE</option>
                </select>
              </div>

              <div class="form-group">
                <label for="requests">Numero Richieste:</label>
                <input
                  id="requests"
                  type="number"
                  [(ngModel)]="loadTestConfig.requests"
                  min="1"
                  max="10000"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label for="concurrency">Concorrenza:</label>
                <input
                  id="concurrency"
                  type="number"
                  [(ngModel)]="loadTestConfig.concurrency"
                  min="1"
                  max="100"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label for="duration">Durata (secondi):</label>
                <input
                  id="duration"
                  type="number"
                  [(ngModel)]="loadTestConfig.duration"
                  min="1"
                  max="3600"
                  class="form-control"
                >
              </div>
            </div>

            <div class="test-actions">
              <button
                (click)="startLoadTest()"
                class="btn btn-primary"
                [disabled]="isLoadTesting"
              >
                {{ isLoadTesting ? 'Test in corso...' : 'Avvia Test' }}
              </button>
              <button
                (click)="stopLoadTest()"
                class="btn btn-danger"
                [disabled]="!isLoadTesting"
              >
                Ferma Test
              </button>
            </div>
          </div>

          <!-- Test Results -->
          <div *ngIf="loadTestResults.length > 0" class="test-results">
            <h3>Risultati Test</h3>
            <div class="results-grid">
              @for (result of loadTestResults; track $index) {
                <div class="result-card">
                  <h4>Test {{ $index + 1 }}</h4>
                  <div class="result-stats">
                    <span class="result-item">
                      <strong>Endpoint:</strong> {{ result.endpoint }}
                    </span>
                    <span class="result-item">
                      <strong>Richieste:</strong> {{ result.totalRequests }}
                    </span>
                    <span class="result-item">
                      <strong>Successi:</strong> {{ result.successRequests }}
                    </span>
                    <span class="result-item">
                      <strong>Errori:</strong> {{ result.errorRequests }}
                    </span>
                    <span class="result-item">
                      <strong>Tempo medio:</strong> {{ result.averageTime }}ms
                    </span>
                    <span class="result-item">
                      <strong>Successo:</strong> {{ result.successRate }}%
                    </span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div *ngIf="isLoadTesting" class="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="testProgress"></div>
        </div>
        <p class="progress-text">Test in corso: {{ testProgress }}%</p>
      </div>
    </div>
  }
</div>
